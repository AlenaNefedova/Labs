:imagesdir: Images
:figure-caption: Рисунок
:table-caption: Таблица
:toc:
:toc-title: ОГЛАВЛЕНИЕ:
== Лабораторная работа 9



=== Задание:

* Измерить температуру в комнате с помощью АЦП и инженекторных каналов.
* Значения температуры передать через UART и отобразить в программе Terminal.


=== 1. Настройка АЦП

Для преобразования сигнала, полученного со встроенного в микроконтроллер датчика температуры, в цифровой код используется АЦП.

*Аналого-цифровой преобразователь* (АЦП) – устройство, которое принимает аналоговые сигналы и генерирует соответствующие им цифровые сигналы, пригодные для дальнейшей обработки микропроцессором или другим цифровым устройством.

Для преобразования сигналов, где нужна высокая точность применяется _сигма-дельта АЦП_. Но в основном микроконтроллеры содержат в себе АЦП _последовательного приближения_ (_SAR_).

Согласно документации встроенный температурный сенсор передает напряжение на 18 канал.

.Канал для temperature sensor
image::1.png[]

.Настройка регистра последовательного преобразования
image::3.png[]
image::4.png[]

* Код настройки АЦП:

[source,c]
----
 //Переключение на частоту ADC1

   RCC::APB2ENR::ADC1EN::Enable::Set();

   //Переключение на температурный сенсор

   ADC_Common::CCR::TSVREFE::Enable::Set();

   //Установка режима одиночного преобразования

   ADC1::CR1::RES::Bits12::Set();
   ADC1::CR2::CONT::SingleConversion::Set();
   ADC1::CR2::EOCS::SingleConversion::Set();

   // Установка частоты диспретизации в 84 цикла для 18 каналa

   ADC1::SMPR1::SMP18::Cycles84::Set();

   // Установка длины последовательного преобразования на 1

   ADC1::JSQR::JL::Conversion1::Set();

   // Установка первого преобразования на 18 канал

   ADC1::JSQR::JSQ4::Set(18);

  return 1;
}
}
----

Преобразовать код с АЦП в температуру можно по формуле, показанной на рисунке 3.

.Формула для раcчета температуры
image::2.png[]

.Числовые значения необходимых точек
image::5.png[]

* Так как температура определяется по некоторой прямой, заданной уравнением

y = k*x + b,

где y - искомая температура; x - код, полученный с АЦП (максимум 4096, т.к. разрядность 12 бит).

Для настройки и работы модуля UART нужно всего несколько регистров:

* USART_CR1/CR2/CR3 -  регистр настройки 1
* USART_DR -  регистр принятого символа (регистр данных)
* USART_BRR – регистр настройки скорости передачи
* USART_SR  - регистр состояния

Порядок запуска модуля UART:

* Подключить USART к источнику тактирования – устанавливаем бит USART2EN в регистре APB1ENR (АЦП тактируется от матрицы шин APB1).
* Необходимо сконфигурировать порты. Настроить порты, на альтернативную функцию нужного модуля USART
* Настроить формат передачи байт, с помощью регистра CR1 и CR2
* Задать скорость передачи с помощью регистра BRR
* Разрешить передачу помощью бита TE и если надо прием, с помощью бита RE в модуле USART с помощью регистра CR1
* Включить сам модуль USART битом UE  в регистре CR1

[source,c]
----

//Порт А к системе тактирования

  RCC::AHB1ENR::GPIOAEN::Enable::Set();

  //Порт А2 и А3 на альтернативный режим работы

  GPIOA::MODER::MODER2::Alternate::Set();
  GPIOA::MODER::MODER3::Alternate::Set();

  //Назначение портов А2 и А3 на альтернативную функцию 7
  GPIOA::AFRL::AFRL2::Af7::Set();  // USART2 Tx
  GPIOA::AFRL::AFRL3::Af7::Set();  // USART2 Rx

  //Подключаем USART2 к системе тактирования APB1
  RCC::APB1ENR::USART2EN::Enable::Set();

  USART2::CR1::OVER8::OversamplingBy16::Set();
  USART2::CR1::M::Data8bits::Set();
  USART2::CR1::PCE::ParityControlDisable::Set();

  USART2::BRR::Write(8'000'000 / 9600); // 8 МГц с внешнего генератора HSE
  USART2::CR1::UE::Enable::Set();
----
