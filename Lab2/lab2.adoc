:imagesdir: Images
:figure-caption: Рисунок
== Лабораторная работа 2

=== Задание
*  Написать программу вычисляющую следующее выражение:
+
**-3/3U *3 **
+
и объяснить результат.
*  Подключить плату к своему домашнему компьютеру, проверить что все работает и плата прошивается.
*  Запустить на плате Lab1 и выбрать проект *iarproject.ewp*. В *main* добавить код для зажигания светодиодов. Показать результат проделанной работы.



=== 1 Программа для вычисления заданного выражения

* Напишем программу, вычисляющую заданное выражение. Решение выражения выведем в окне *Terminal I/O* (рисунок 1).

.Код программы и результат выражения
image::1.png[]

* Как видим в выражении присутствует буква U, которая указывает на то, что деление производится на беззнаковое число, при этом остальные цифры знаковые. Но в данном случае происходит беззнаковое деление. Если привести -3 к безнаковому типу (от 0 до 4294967295), используя дополнительный код, то получится число 4294967293. Оно не делится на 3 без остатка. В итоге при делении -3/3U получается целое число 1431655764. Затем оно умножается на 3 и получается число 4294967292. Это число преобразуется к знаковому типу int и получается -4.

Проверим: для числа -4 прямой двоичный код: 1000 0000 0000 0000 0000 0000 0000 0100. Инвертируем его, кроме первой знаковой единицы:1111 1111 1111 1111 1111 1111 1111 1011 и прибавляем 1, получаем 1111 1111 1111 1111 1111 1111 1111 1100, что соответствует числу 4294967292.



=== 2 Подключение и работа с платой
==== 2.1 Подсоединение платы к компьютеру

Подкючим плату *STM32F411RE* к компьютеру через USB разъем, при этом должен загореться красный светодиод (рисунок 2). Если этого не произошло, необходимо проверить соединение (проблема может быть в кабеле или в неработающем гнезде usb входа).

.Успешное подключение платы
image::2.png[]


==== 2.2 Прошивка платы


* Создаем проект (С++ с main) с настройками под микроконтроллер *STM32F411RE*.

В свойствах проекта выбираем модель микроконтроллера ST ⇒ STM32F4⇒ STM32F411⇒ ST STM32F411RE.

* Собираем проект и появляется ошибка (рисунок 3).

.Ошибка при запуске проекта
image::3.png[]

* Чтобы убрать ошибку переходим в опции проекта (рисунок 4):

С/С++ Compiler > List > убираем галочку Output assembler file

.Выбор нужных параметров проекта
image::4.png[]

* Заново собираем проект. Ошибки не появляются, на плате загорается зеленный светодиод, что говорит о прошивке платы (рисунок 5).


.Результат успешной прошивки платы
image::5.png[]

==== 2.3 Включение светодиода
* Скачиваем папку Lab1 на компьютер и открываем проект *iarproject.ewp* (рисунок 6).

.Добавление проекта
image::6.png[]

* Снова выбираем наш микроконтроллер **STM32F411RE ** и убираем галочку _Output assembler file_ (рисунок 4).

* После этого переходим в раздел _Debbuger_  и вместо режима симуляции выбираем внутрисхемный программатор _ST-Link_, предназначенный для записи прошивки в память микроконтроллера серии STM8 и STM32 (рисунок 7).

.Выбор внутрисхемного программатора ST-Link
image::7.png[]

* В *main* добавим код для зажигания светодиода. Перед этим подключим нужные библиотеки.

[source, c]
----
#include "rccregisters.hpp" // for RCC
#include "gpioaregisters.hpp" //for Gpioa

std::uint32_t SystemCoreClock = 16'000'000U;

extern "C" {
int __low_level_init(void)
{
  //Switch on external 16 MHz oscillator
  RCC::CR::HSION::On::Set();
  while (RCC::CR::HSIRDY::NotReady::IsSet())
  {

  }
  //Switch system clock on external oscillator
  RCC::CFGR::SW::Hsi::Set();
  while (!RCC::CFGR::SWS::Hsi::IsSet())
  {

  }

  RCC::APB2ENR::SYSCFGEN::Enable::Set();

  return 1;
}
}


int main()
{
  RCC::AHB1ENR::GPIOAEN::Enable::Set();
  GPIOA::MODER::MODER5::Output::Set();
  GPIOA::ODR::ODR5::High::Set();

  return 0;
}
----

Запускаем программу. На рисунке 8 видим как загорелся зеленый светодиод.

.Результат работы программы
image::8.png[]




