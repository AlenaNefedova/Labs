:imagesdir: Images
:figure-caption: Рисунок
:table-caption: Таблица
== Лабораторная работа 5

=== Задание:
* Написать программу, которая моргает *всеми 4 светодиодами* через прямой доступ к памяти по адресам. Тактирование системной частоты произвести с модуля *PLL*, так, чтобы системная частота была *30 МГц*.


=== 1. Работа с платой

Необходимо, чтобы *4* светодиода, подключенных к портам *C.5, C.8, C.9, A.5*, одновременно загорались и гасли, при этом нужно задать системную частоту *30 МГц* с модуля *PLL*.

* Рассмотрим систему тактирования нашего микроконтроллера.

.Система тактирования микроконтроллера STM32F411
image::1.png[]

Как видим для формирования системной тактовой частоты *SYSCLK* могут использоваться источники:

* *HSI* (high-speed internal) — внутренний высокочастотный RC-генератор на 16 МГц.

* *HSE* (high-speed external) — внешний высокочастотный генератор на 8 МГц.

* *PLL* — система ФАПЧ. Точнее сказать, это вовсе и не генератор, а набор из умножителей и делителей, исходный сигнал он получает от HSI или HSE, а на выходе у него уже другая частота.

* *LSI* (low-speed internal) — низкочастотный внутренний RC-генератор на 37 кГц.

* *LSE* (low-speed external) — низкочастотный внешний источник на 32,768 кГц.

В прошлой лабораторной работе тактирование происходило от *HSI* генератора. Теперь изменим код, чтобы системная частота задавалась от *PLL* модуля.


==== 1.1 Алгоритм настройки частоты

* Определить какие источники частоты нужны

* Включить нужный источник (используя Clock Control register (RCC::CR))

* Дождаться стабилизации источника ((..RDY) Clock Control register (RCC::CR))

* Назначить нужный источник на системную частоту (используя Clock Configuration Register (RCC::CFGR))

* Дождаться пока источник не переключиться на системную частоту (используя Clock Configuration Register (RCC::CFGR))


Включение и выключение основных генераторов производится через регистр *RCC_CR* — Clock Control register.

Пусть в нашей работе модуль *PLL* исходный сигнал получает от генератора *HSI* с частотой 16 МГц.

Перед тем как включить *PLL* настроем нужную частоту. С помощью регистров *PLLM*, *PLLN*, *PLLP* можно подобрать любую частоту до 100 Мгц включительно по формуле:

f = f(PLL clock input) × (PLLN / PLLM) /PLLP

Тогда чтобы получить 30 МГц возьмем множители:

30 МГц = 16Мгц × (120 / 32)

В описании к микроконтроллеру видим что, чтобы включить PLL, необходимо перевести бит *PLLON* в единицу (рисунок 2).

.Включение системы PLL
image::2.png[]

* Сразу после установки частоты, нужно проверить, что частота с нового источника стабилизировалась (рисунок 3).

.Контроль стабилизации источника
image::3.png[]

После включения генераторов частоты, необходимо выбрать один из них в качестве источника для системной частоты SYSCLK. Выбор осуществляется через регистр RCC_CFGR — Clock Configuration Register (рисунок 4).

.Выбор источника частоты
image::4.png[]



==== 1.2 Код программы:

[source, c]
----
#include <iostream>
#include "rccregisters.hpp" // for RCC
#include "gpioaregisters.hpp" //for Gpioa
#include "gpiocregisters.hpp" //for Gpioc

std::uint32_t SystemCoreClock = 16'000'000U;

extern "C"
 {
   int __low_level_init(void)
   {
     RCC::CR::HSION::On::Set();
     while (RCC::CR::HSIRDY::NotReady::IsSet())
     {
     }
     // Установка коэффициентов пересчета частоты
     RCC::PLLCFGR::PLLN0::Set(120);
     RCC::PLLCFGR::PLLM0::Set(32);

     RCC::CR::PLLON::On::Set();
     while (RCC::CR::PLLRDY::Unclocked::IsSet())
     {
     }

     RCC::CFGR::SW::Pll::Set();

     while (!RCC::CFGR::SWS::Pll::IsSet())
     {
     }
     return 1;
   }
 }
----

При запуске программы появляется ошибка, в связи с тем, что PLLM0 неизвестна программе, поэтому переходим в Go to Definition of PLLM0 и попадаем в файл, где расположены строчки регистров. В данном файле rccregisters.hpp производим замену строчки:

[source, c]
----
using FieldValues = RCC_PLLCFGR_PLLM_Values<RCC::PLLCFGR, 0, 5, NoAccess, NoAccess> ;
----

на строчку:

[source, c]
----
using PLLM0 = RCC_PLLCFGR_PLLM_Values<RCC::PLLCFGR, 0, 5, ReadWriteMode, RCCPLLCFGRBase> ;
----

==== 1.3 Результат работы программы

.Результат работы программы
image::1.gif[]
