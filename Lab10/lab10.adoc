:imagesdir: Images
:figure-caption: Рисунок
:table-caption: Таблица
:toc:
:toc-title: ОГЛАВЛЕНИЕ:
== Лабораторная работа 10



=== Задание:

* С помощью прерываний по таймерам TIM2 и TIM3 произвести мигание светодиодов (раз в секунду для таймера TIM2 и раз в полсекунды для таймера TIM3).
* По прерыванию передать через USART и отобразить в программе Terminal сообщение "Hello World!".


=== 1. Мигание светодиодов

Откроем программу, где у нас настроена системная тактовая частота микроконтроллера от внешнего высокочастотного генератора на 8 МГц и настроены 8 и 5 порты на выход.

Мигание светодиодов будет осуществляться с помощью прерывания по таймеру.

*Прерывание* (interrupt) - сигнал, сообщающий микропроцессору о наступлении какого-либо события от переферии. При этом выполнение текущей последовательности команд приостанавливается, и управление передается _обработчику прерывания_, который реагирует на событие и обслуживает его, после чего возвращает управление в прерванный код.

Все это делается через таблицу векторов прерываний, которая содержит  адреса обработчиков прерываний или список векторов прерывания.

Подключим для таймеров и прерывания библиотеки:
[source,c]
----
#include "tim2registers.hpp"    //for TIM2
#include "tim3registers.hpp"    //for TIM3
#include "nvicregisters.hpp"    //for NVIC
----

==== 1.1 Работа с таймером TIM2

* Таймер тактируются от шины *APB1*. Чтобы таймер заработал, его нужно подключить к системе тактирования, т.е. к шине APB1.
Подключение к системе тактирование выполняется через регистр *APB1ENR* модуля *RCC*.

.Регистр включения таймера TIM2
image::1.png[]

* Входную частоту таймера можно поделить, записав делитель частоты в регистр *PSC*.

.Регистр TIM2_PSC
image::2.png[]

Делитель определяется следующим образом:
[source,c]
----
constexpr auto SystemClock = 8'000'000U;
constexpr auto TimerClock = 1'000U;
constexpr auto TimerPrescaler = SystemClock / TimerClock;
----

* Нижний и верхний пределы отсчета таймера устанавливаются с помощью регистров CNT и ARR соответственно.

* Для работы с прерыванием нужно разрешить глобальное прерывание периферийного модуля. За работу с прерываниями в *NVIC* отвечают несколько регистров (рисунок 3).

.Сопоставление прерываний с переменными прерываний
image::4.png[]

* Для настройки прерывания необходимо воспользоваться таблицей векторов прерываний, согласно которой таймер TIM2 имеет 28 позицию.

.Таблица векторов прерываний
image::3.png[]

* Соответственно в регистр  *NVIC_ISER0* записываем номер 28.

* Далее разрешаем прерывание от таймера с помощью регистра *TIMx_DIER*.  В регистре *UIE* устанавливаем 1 бит.

.Разрешение прерывания
image::5.png[]

* Включение таймера производиться с помощью бита *CEN* в регистре *CR1*.

Листинг кода настройки таймера TIM2:

[source,c]
----
//Настройка таймера 2
RCC::APB1ENR::TIM2EN::Enable::Set();
TIM2::PSC::Write(TimerPrescaler);

//Установка нижнего и верхнего предела отсчета таймера, то есть он считает от 0 до 1000 мс (или раз в 1 секунду будет моргать светодиод)
TIM2::ARR::Write(1000);
TIM2::CNT::Write(0);

//Настройка прерывания
NVIC::ISER0::Write(1 << 28U);    //Разрешить глобальное прерывание
TIM2::DIER::UIE::Enable::Set();
TIM2::CR1::CEN::Enable::Set();
----